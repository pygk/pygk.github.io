---
layout: single
title: ì‹¤ìŠµ 2. CML ê³¼ DVC ì—°ê³„ë¥¼ í†µí•œ Model Metric Tracking
date: 2022-05-06 14:12:00 +0900
last_modified_at: 2022-05-06 14:12:00 +0900
category: mlops
tags: ["CI/CD Pipeline"]
published: false

---

<aside>
ğŸ’¡ **ì‹¤ìŠµ ëª©í‘œ
1. Github Actions ë¥¼ í™œìš©í•˜ì—¬ ì˜ˆì œ ë¨¸ì‹ ëŸ¬ë‹ ì½”ë“œ ì‹¤í–‰í•˜ì—¬ ì„±ëŠ¥ ì§€í‘œ ì¶œë ¥í•˜ê¸°
2. CML ì„ ì‚¬ìš©í•˜ì—¬ ì„±ëŠ¥ ì§€í‘œë¥¼ ë ˆí¬íŠ¸ í˜•íƒœë¡œ ì¶œë ¥í•˜ê¸°
3. ë¶„ì„ ì½”ë“œ ë³€ê²½ í›„ ì¬ë°°í¬ ì‹œ ë ˆí¬íŠ¸ ì¬ìƒì„± í•˜ê¸°
4. DVC ë¥¼ í™œìš©í•˜ì—¬ Metric ì˜ ë³€í™” ì¶”ì í•˜ê¸°**

</aside>

### **Github Actions ë¥¼ í™œìš©í•˜ì—¬ ì˜ˆì œ ë¨¸ì‹ ëŸ¬ë‹ ì½”ë“œ ì‹¤í–‰í•˜ì—¬ ì„±ëŠ¥ ì§€í‘œ ì¶œë ¥í•˜ê¸°**

- New Repository
    - Repository name : github-actions-cml
- ì‹¤ìŠµ Github Repo ë³µì‚¬
    - [https://github.com/yunjjun/github-actions-project.git](https://github.com/yunjjun/github-actions-project.git) ì— ì ‘ì†í•˜ì—¬ github-actions-cml ë¸Œëœì¹˜ë¡œ ì´ë™í•˜ì—¬ ìš°ì¸¡ ìƒë‹¨ Fork í´ë¦­
    - ë˜ëŠ” í•´ë‹¹ ë§í¬ ë³µì‚¬ í›„ ìì‹ ì˜ Github Repo ì— push
        
        ```bash
        # ì‹¤ìŠµ Repo ë°ì´í„° ë‹¤ìš´ë¡œë“œ
        # ë¡œì»¬ì— ìƒˆ í´ë” ìƒì„±
        git init
        git remote add origin <git ì €ì¥ì†Œ>
        git pull origin main
        git checkout -b main
        git config --global user.email <ì´ë©”ì¼ ì£¼ì†Œ>
        git config --global user.name <ì´ë¦„>
        # ì‹¤ìŠµ Repo ì˜ ë°ì´í„°ë¥¼ ìƒˆ í´ë”ë¡œ ë³µì‚¬
        git add .
        git commit -m "first commit"
        git push origin main
        ```
        
- [Red Wine Quality](https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009) ë°ì´í„° ì†Œê°œ
- í›ˆë ¨ ì½”ë“œ (train.py) ì†Œê°œ
- .github/workflows/cml.yml íŒŒì¼ ìƒì„±
    - ì•„ë˜ ì½”ë“œ ë³µì‚¬
    
    ```yaml
    name: model-training
    on: [push]
    jobs:
      run:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v2
          - uses: actions/setup-python@v2
          - uses: iterative/setup-cml@v1
          - name: Train model
            env:
              REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
              pip install -r requirements.txt
              python train.py
    					echo "MODEL METRICS"
    					cat metrics.txt
    ```
    
- ìƒˆë¡œìš´ ë¸Œëœì¹˜ ë§Œë“¤ì–´ì„œ commit â†’  build â†’ terminal ì— metric í”„ë¦°íŠ¸ â†’ ì¶©ë¶„í•˜ì§€ ì•ŠìŒ

### **CML ì„ ì‚¬ìš©í•˜ì—¬ ì„±ëŠ¥ ì§€í‘œë¥¼ ë ˆí¬íŠ¸ í˜•íƒœë¡œ ì¶œë ¥í•˜ê¸°**

- [CML](https://cml.dev/) : ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤ í”„ë¡œì íŠ¸ë¥¼ ì§€ì†ì ìœ¼ë¡œ í†µí•©ì‹œí‚¤ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤
    
    [GitHub - iterative/cml: â™¾ï¸ CML - Continuous Machine Learning | CI/CD for ML](https://github.com/iterative/cml)
    
- Markdown í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
    
    ```yaml
    echo "## MODEL METRICS" > report.md
    cat metrics.txt >> report.md
    ```
    
- CML Command ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶„ì„ ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
    - [CML Command ì‚´í´ë³´ê¸°](https://cml.dev/doc/ref/pr)
    
    ```yaml
    echo "## Data viz" >> report.md
    cml-publish feature_importance.png --md >> report.md
    cml-publish residuals.png --md >> report.md
    cml-send-comment report.md
    ```
    
- Build

### **ë¶„ì„ ì½”ë“œ ë³€ê²½ í›„ ì¬ë°°í¬ ì‹œ ë ˆí¬íŠ¸ ì¬ìƒì„± í•˜ê¸°**

- ë¶„ì„ ì½”ë“œ ë³€ê²½
    - max_depth ë¥¼ 2 â†’ 5 ë³€ê²½
    - commit ë³€ê²½
    - Build
- ê²°ê³¼ ë³€í™” í™•ì¸
- Commit ê¸°ë¡ìœ¼ë¡œ í•´ë‹¹ ë³€í™” ì‹œì˜ ë°ì´í„°,ì½”ë“œ,í™˜ê²½ í™•ì¸ ê°€ëŠ¥

### **DVC ë¥¼ í™œìš©í•˜ì—¬ Metric ì˜ ë³€í™” ì¶”ì í•˜ê¸°**

- [Github Repo](https://github.com/yunjjun/github-actions-project/tree/github-actions-dvc) Fork
    - [ë°ì´í„° í™•ì¸](https://www.sciencedirect.com/science/article/pii/S2352340920303048) ë° ë‹¤ìš´ë¡œë“œ
    - process_data.py ì‹¤í–‰
    - train.py ì‹¤í–‰
        
        ```bash
        ## AttributeError: 'Series' object has no attribute 'to_numpy' ì—ëŸ¬ ì‹œ ì°¸ê³ 
        pip install --upgrade pandas
        ```
        
- Metric ì˜ ë³€í™”ëŠ” ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œ?
    - [Git diff](https://git-scm.com/docs/git-diff)
        - ìˆ˜ì¹˜ ë¹„êµë³´ë‹¤ëŠ” ì½”ë“œì˜ ë³€í™”ë¥¼ ì•Œê¸° ìœ„í•´ ë³´í†µ ì‚¬ìš©í•˜ë¯€ë¡œ í™œìš©ì´ ì–´ë µë‹¤.
        - íŒŒì¼ ë³€ê²½ ì´ë ¥ì„ ì•Œê¸° ì–´ë µë‹¤ â†’ ëª¨ë¸ë§ ì „ëµ ë³€ê²½ì„ ì•Œê¸° ì–´ë µë‹¤.
    - [DVC](https://dvc.org/) ì‚¬ìš©!
        - install dvc
        
        ```bash
        pip install dvc
        ```
        
        - íŒŒì´í”„ë¼ì¸ ë¹Œë“œ
            - ì´ˆê¸°í™”
                
                ```bash
                # ì´ˆê¸°í™”
                dvc init
                # dvc.yaml ìƒì„±
                dvc run -n process -d process_data.py -d data_raw.csv -o data_processed.csv --no-exec python process_data.py
                ```
                
            - ì „ì²´ ì½”ë“œ
                
                ```yaml
                stages:
                  process:
                    cmd: python process_data.py
                    deps:
                    - process_data.py
                    - data_raw.csv
                    outs:
                    - data_processed.csv
                  train:
                    cmd: python train.py
                    deps:
                    - train.py
                    - data_processed.csv
                    outs:
                    - by_region.png
                    metrics:
                    - metrics.json:
                        cache: false
                ```
                
        - [íŒŒì´í”„ë¼ì¸ì— ë”°ë¼ ì¬ìƒì„±](https://dvc.org/doc/command-reference/repro)
            
            ```bash
            # ê° ë‹¨ê³„ë³„ë¡œ ì¬ìƒì„±
            dvc repro
            ```
            
        - .github/workflows/train.yaml ìƒì„±
            
            ```yaml
            name: dvc-cml
            on: [push]
            jobs:
              run:
                runs-on: [ubuntu-latest]
                container: docker://dvcorg/cml-py3:latest
                steps:
                  - uses: actions/checkout@v2
                  - name: cml_run
                    env:
                      repo_token: ${{ secrets.GITHUB_TOKEN }}
                    run: |
                      pip install -r requirements.txt
                      dvc repro 
            
                      git fetch --prune ## https://git-scm.com/docs/git-fetch
                      dvc metrics diff --show-md master > report.md
            
                      echo "## Validating results by region"
                      cml-publish by_region.png --md >> report.md
                      cml-send-comment report.md
            ```
            
        - ëª¨ë¸ë§ ë³€ê²½í•˜ì—¬ í…ŒìŠ¤íŠ¸
            - ìƒˆë¡œìš´ branch (experiment) ìƒì„±
            - [train.py](http://train.py) ìˆ˜ì • (LogisticRegression â†’ [QuadraticDiscriminantAnalysis](https://scikit-learn.org/stable/modules/generated/sklearn.discriminant_analysis.QuadraticDiscriminantAnalysis.html))
                
                ```python
                # from sklearn.linear_model import LogisticRegression
                from sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis
                ...
                # clf = LogisticRegression()
                clf = QuadraticDiscriminantAnalysis()
                ```
                
            - commit â†’ build
            - ë³€ê²½ê°’ í™•ì¸ !